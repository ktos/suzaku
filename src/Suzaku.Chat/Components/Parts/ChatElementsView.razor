@using Microsoft.Extensions.Options
@using Suzaku.Chat.Services
@using Suzaku.Chat.Models
@inject IOptions<UserConfiguration> UserConfig

@for(int i = 0; i < Elements.Count; i++)
{
	var item = Elements[i];
	var prev = i > 0 ? Elements[i - 1] : null;

	if (item is Busy busy)
	{
		<BusyMarker Sender="@busy.Sender"></BusyMarker>
	}
	else if (item is Attachment attachment)
	{
		var grouped = false;
		if (prev != null && prev is Attachment prevMsg && prevMsg.Sender == attachment.Sender && (attachment.Timestamp - prevMsg.Timestamp) < TimeSpan.FromMinutes(5))
		{
			grouped = true;
		}

		<ChatAttachment IsGrouped="grouped" IsMine="@FormatIsMine(attachment)" Sender="@attachment.Sender" Timestamp="attachment.Timestamp" Content="@attachment.Content"></ChatAttachment>
	}
	else if (item is Message message)
	{
		var grouped = false;
		if (prev != null && prev is Message prevMsg && prevMsg.Sender == message.Sender && (message.Timestamp - prevMsg.Timestamp) < TimeSpan.FromMinutes(5))
		{
			grouped = true;
		}

		<ChatMessage IsGrouped="grouped" IsMine="@FormatIsMine(message)" Sender="@message.Sender" Timestamp="message.Timestamp" Content="@message.Content"></ChatMessage>
	}
}

@code {
	[Parameter] public required IList<Element> Elements { get; set; }

	private bool FormatIsMine(Message message)
	{
		return message.Sender == "User";
	}
}
